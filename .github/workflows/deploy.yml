name: Deploy Demo Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    environment: secrets
    defaults:
      run:
        working-directory: ./iac

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ github.run_id }}
          audience: sts.amazonaws.com
          mask-aws-account-id: false
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=${{ secrets.TERRAFORM_STATE_KEY }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TERRAFORM_DYNAMODB_TABLE }}"
      
      - name: Terraform Plan
        run: terraform plan

  wait-for-approval:
    name: Wait for Approval
    needs: terraform-plan
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      - name: Approval Required
        run: echo "Approved! Proceeding with terraform apply..."

  terraform-apply:
    name: Terraform Apply
    needs: wait-for-approval
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./iac

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          aws-region: us-east-1
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ github.run_id }}
          audience: sts.amazonaws.com
          mask-aws-account-id: false
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=${{ secrets.TERRAFORM_STATE_KEY }}" \
            -backend-config="region=${{ secrets.AWS_REGION }}" \
            -backend-config="dynamodb_table=${{ secrets.TERRAFORM_DYNAMODB_TABLE }}"
 
      - name: Terraform Apply
        run: terraform apply -auto-approve
      
      - name: Get EC2 IPs
        id: ec2_ips
        run: |
          echo "instance_01=$(terraform output -raw instance_01_public_ip)" >> $GITHUB_OUTPUT
          echo "instance_02=$(terraform output -raw instance_02_private_ip)" >> $GITHUB_OUTPUT
      
      - name: Create Ansible Inventory
        run: |
          cat > ../ansible/inventory.ini <<EOF
          [app]
          ${{ steps.ec2_ips.outputs.instance_01 }}

          [app:vars]
          ansible_user=ec2-user
          ansible_ssh_private_key_file=./id_rsa
          ansible_python_interpreter=/usr/bin/python3
          ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
          EOF

      - name: Create Ansible Vars File
        run: |
          cat > ../ansible/vars.yml <<EOF
          ---
          app_dir: "/home/ec2-user/app"
          api_port: "5000"
          target_instance_ip: "${{ steps.ec2_ips.outputs.instance_02 }}"
          EOF
      
      - name: Upload Inventory
        uses: actions/upload-artifact@v4
        with:
          name: ansible-inventory
          path: ansible/inventory.ini

      - name: Upload Vars File
        uses: actions/upload-artifact@v4
        with:
          name: ansible-vars
          path: ansible/vars.yml

  ansible:
    name: Ansible Configure
    needs: terraform-apply
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ansible
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Inventory
        uses: actions/download-artifact@v4
        with:
          name: ansible-inventory
          path: ansible

      - name: Download Vars File
        uses: actions/download-artifact@v4
        with:
          name: ansible-vars
          path: ansible
      
      - name: Setup SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: pip install ansible
      
      - name: Wait for EC2 ready
        run: sleep 90
      
      - name: Run Ansible Playbook
        run: ansible-playbook -i inventory.ini playbook.yml